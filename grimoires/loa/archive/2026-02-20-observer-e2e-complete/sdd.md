# SDD: Observer End-to-End Integration (Cycle-032)

> **Version**: 1.0
> **Date**: 2026-02-20
> **Cycle**: cycle-032
> **Depends on**: Cycle-027 (echelon-verify), Cycle-031 (Theatre Template Engine)

---

## 1. Executive Summary

This cycle creates integration glue between two independently tested systems — no new engine or pipeline work. The architecture consists of three bridge adapters, a runner script, and tests. Total estimated LOC: ~500 (glue) + ~300 (tests) + ~100 (template/config).

---

## 2. System Architecture

### Component Diagram

```
┌────────────────────────────────────────────────────────────┐
│                    Runner Script                            │
│  scripts/run_observer_theatre.py                           │
│                                                             │
│  1. Ingest (GitHubIngester)                                │
│  2. Convert (GroundTruthAdapter)                           │
│  3. Commit (CommitmentProtocol)                            │
│  4. Replay (ReplayEngine + bridges)                        │
│  5. Certify (TheatreCalibrationCertificate)                │
│  6. Validate (jsonschema)                                  │
│  7. Evidence (EvidenceBundleBuilder)                        │
└────────────────┬──────────────┬─────────────┬──────────────┘
                 │              │             │
    ┌────────────▼──┐   ┌──────▼──────┐  ┌──▼──────────────┐
    │ GroundTruth   │   │ Oracle      │  │ Scoring         │
    │ Adapter       │   │ Bridge      │  │ Bridge          │
    │               │   │             │  │                 │
    │ Record → Ep.  │   │ Theatre     │  │ Theatre         │
    │               │   │ Protocol →  │  │ ScoringFn →     │
    │               │   │ Verify      │  │ Anthropic       │
    │               │   │ Adapter     │  │ Scorer          │
    └───────────────┘   └─────────────┘  └─────────────────┘
          │                    │                   │
    ┌─────▼────────────────────▼───────────────────▼─────────┐
    │                  Existing Code (frozen)                  │
    │                                                         │
    │  Cycle-027:                   Cycle-031:                │
    │  echelon_verify/              theatre/engine/            │
    │  ├─ ingestion/                ├─ oracle_contract.py      │
    │  ├─ oracle/                   ├─ replay.py               │
    │  ├─ scoring/                  ├─ scoring.py              │
    │  └─ models.py                 ├─ commitment.py           │
    │                               ├─ certificate.py          │
    │                               ├─ evidence_bundle.py      │
    │                               └─ tier_assigner.py        │
    └─────────────────────────────────────────────────────────┘
```

### File Layout

```
theatre/
├── engine/              # Cycle-031 (frozen, no changes)
├── fixtures/            # Cycle-031 fixtures (frozen)
└── integration/         # NEW — Cycle-032 integration glue
    ├── __init__.py
    ├── ground_truth_adapter.py   # Seam 1: Record → Episode
    ├── oracle_bridge.py          # Seam 2: Theatre → Verify adapter
    ├── scoring_bridge.py         # Seam 3: Theatre → AnthropicScorer
    └── observer_template.json    # Real Observer Theatre template

scripts/
└── run_observer_theatre.py       # Runner entry point

tests/
└── theatre/
    └── test_observer_integration.py   # E2E integration tests

output/
└── certificates/                 # Generated certificates (gitignored)
```

---

## 3. Detailed Component Design

### 3.1 Ground Truth Adapter (`theatre/integration/ground_truth_adapter.py`)

**Purpose**: Convert Cycle-027's PR-specific `GroundTruthRecord` into Cycle-031's generic `GroundTruthEpisode`.

```python
def convert_records_to_episodes(
    records: list[GroundTruthRecord],
    follow_up_questions: dict[str, str],  # record.id → question
) -> list[GroundTruthEpisode]:
    """Convert verification pipeline records to Theatre episodes."""

def convert_single_record(
    record: GroundTruthRecord,
    follow_up_question: str,
) -> GroundTruthEpisode:
    """Convert one GroundTruthRecord → one GroundTruthEpisode."""
```

**Field Mapping**:

| GroundTruthEpisode field | Source |
|--------------------------|--------|
| `episode_id` | `record.id` (PR number as string) |
| `input_data.title` | `record.title` |
| `input_data.description` | `record.description` |
| `input_data.diff_content` | `record.diff_content` |
| `input_data.files_changed` | `record.files_changed` |
| `input_data.follow_up_question` | Pre-generated by AnthropicScorer |
| `expected_output` | `None` (open-ended scoring) |
| `labels.author` | `record.author` |
| `labels.url` | `record.url` |
| `labels.repo` | `record.repo` |
| `labels.github_labels` | `record.labels` |
| `metadata.timestamp` | `record.timestamp` (ISO string) |

**Key design decision**: `follow_up_question` is included in `input_data` because the scoring bridge needs it to evaluate reply_accuracy, and it must be part of the committed dataset (frozen at commit time for reproducibility).

### 3.2 Oracle Bridge (`theatre/integration/oracle_bridge.py`)

**Purpose**: Implement Cycle-031's `OracleAdapter` protocol while delegating to Cycle-027's oracle invocation logic.

```python
class VerificationOracleBridge:
    """Bridges Theatre OracleAdapter protocol to echelon-verify oracle."""

    def __init__(
        self,
        verify_adapter: echelon_verify.oracle.OracleAdapter,
    ):
        self.verify_adapter = verify_adapter

    async def invoke(self, input_data: dict[str, Any]) -> dict[str, Any]:
        """Theatre protocol: dict in → dict out."""
```

**Flow**:
1. Unpack `input_data` → reconstruct `GroundTruthRecord` (required fields only: id, title, description, diff_content, files_changed)
2. Extract `follow_up_question` from `input_data`
3. Call `self.verify_adapter.invoke(ground_truth_record, follow_up_question)`
4. Pack `OracleOutput` → return dict: `{summary, key_claims, follow_up_response, metadata, latency_ms}`

**Error handling**: If the Cycle-027 adapter raises, let it propagate — Cycle-031's `invoke_oracle()` wrapper handles timeouts and retries.

### 3.3 Scoring Bridge (`theatre/integration/scoring_bridge.py`)

**Purpose**: Implement Cycle-031's `ScoringFunction` protocol while delegating to Cycle-027's `AnthropicScorer`.

```python
class VerificationScoringBridge:
    """Bridges Theatre ScoringFunction to echelon-verify AnthropicScorer."""

    def __init__(self, scorer: AnthropicScorer):
        self.scorer = scorer

    async def score(
        self,
        criteria: TheatreCriteria,
        input_data: dict[str, Any],
        output_data: dict[str, Any],
        expected_output: dict[str, Any] | None,
    ) -> dict[str, float]:
        """Score using verification pipeline's LLM-based scoring."""
```

**Flow**:
1. Reconstruct `GroundTruthRecord` from `input_data` (same as oracle bridge)
2. Reconstruct `OracleOutput` from `output_data`
3. For each criterion in `criteria.criteria_ids`:
   - `"precision"` → call `self.scorer.score_precision(record, output)`
   - `"recall"` → call `self.scorer.score_recall(record, output)`
   - `"reply_accuracy"` → call `self.scorer.score_reply_accuracy(record, output)`
4. Return `{criterion_id: score_value}` dict

**Design**: The bridge reconstructs domain objects from generic dicts. This is the inverse of the ground truth adapter — it's a necessary cost of bridging generic and domain-specific interfaces.

### 3.4 Observer Theatre Template (`theatre/integration/observer_template.json`)

Real template replacing the test fixture. Key differences from fixture:
- `adapter_type`: `"local"` (not `"mock"`)
- `criteria.weights`: `{precision: 0.4, recall: 0.4, reply_accuracy: 0.2}` (production weights)
- `ground_truth_source`: `"GITHUB_API"`
- No `dataset_hashes` placeholder — computed at commit time from real data

Must pass `TemplateValidator` (schema v2.0.1 + 8 runtime rules).

### 3.5 Runner Script (`scripts/run_observer_theatre.py`)

**Purpose**: Single entry point for end-to-end execution.

```python
async def main(
    repo_url: str = "https://github.com/AITOBIAS04/Echelon",
    limit: int = 10,
    output_dir: str = "output",
    github_token: str | None = None,
    anthropic_api_key: str | None = None,
) -> Path:
    """Run Observer Theatre end-to-end. Returns path to certificate."""
```

**Execution steps**:

| Step | Action | Uses |
|------|--------|------|
| 1 | Ingest PRs from GitHub | `GitHubIngester` (Cycle-027) |
| 2 | Generate follow-up questions | `AnthropicScorer.generate_follow_up_question()` (Cycle-027) |
| 3 | Convert to episodes | `GroundTruthAdapter` (NEW) |
| 4 | Compute dataset hash | `canonical_json()` + SHA-256 (Cycle-031) |
| 5 | Load & validate template | `TemplateValidator` (Cycle-031) |
| 6 | Create commitment receipt | `CommitmentProtocol` (Cycle-031) |
| 7 | Build scoring bridge | `VerificationScoringBridge` (NEW) |
| 8 | Build oracle bridge | `VerificationOracleBridge` (NEW) |
| 9 | Run ReplayEngine | `ReplayEngine` (Cycle-031) |
| 10 | Assign tier | `TierAssigner` (Cycle-031) |
| 11 | Build certificate | `TheatreCalibrationCertificate` (Cycle-031) |
| 12 | Validate against schema | `jsonschema` |
| 13 | Build evidence bundle | `EvidenceBundleBuilder` (Cycle-031) |
| 14 | Write certificate | JSON to `output/certificates/` |

**CLI interface**: `argparse` with:
- `--repo` (default: AITOBIAS04/Echelon)
- `--limit` (default: 10)
- `--output-dir` (default: output)
- `--verbose` flag

**Environment variables**: `GITHUB_TOKEN`, `ANTHROPIC_API_KEY`

---

## 4. Data Architecture

### Ground Truth Episode Format (committed)

```json
{
  "episode_id": "42",
  "input_data": {
    "title": "Fix login timeout handling",
    "description": "Addresses #38 - login form timeout...",
    "diff_content": "--- a/src/auth.py\n+++ b/src/auth.py\n...",
    "files_changed": ["src/auth.py", "tests/test_auth.py"],
    "follow_up_question": "What happens to active sessions when the timeout is changed?"
  },
  "expected_output": null,
  "labels": {
    "author": "developer42",
    "url": "https://github.com/AITOBIAS04/Echelon/pull/42",
    "repo": "AITOBIAS04/Echelon",
    "github_labels": ["bug", "auth"]
  },
  "metadata": {
    "timestamp": "2026-02-15T10:30:00Z"
  }
}
```

### Oracle Output Format (from bridge)

```json
{
  "summary": "This PR fixes a timeout handling bug in the login flow...",
  "key_claims": [
    "Adds 30-second timeout to login form submission",
    "Preserves active sessions across timeout changes"
  ],
  "follow_up_response": "Active sessions are not affected by timeout changes...",
  "metadata": {
    "latency_ms": 2500,
    "model": "claude-sonnet-4-6"
  }
}
```

### Certificate Output Format

Validated against `docs/schemas/echelon_certificate_schema.json` v1.0.0. All required fields populated. `verification_tier` will be `UNVERIFIED` for 10 replays (minimum 50 for `BACKTESTED`).

---

## 5. Testing Strategy

### Unit Tests

| Test | Covers |
|------|--------|
| `test_convert_single_record` | GroundTruthRecord → GroundTruthEpisode field mapping |
| `test_convert_records_batch` | Batch conversion preserving order |
| `test_oracle_bridge_invoke` | Bridge unpacks input_data, calls verify adapter, packs response |
| `test_scoring_bridge_precision` | Delegates precision scoring correctly |
| `test_scoring_bridge_recall` | Delegates recall scoring correctly |
| `test_scoring_bridge_reply_accuracy` | Delegates reply_accuracy scoring correctly |
| `test_scoring_bridge_all_criteria` | Returns dict with all 3 criteria |
| `test_observer_template_validates` | Template passes TemplateValidator |
| `test_certificate_validates_against_schema` | Certificate output matches JSON Schema |

### Integration Tests (with mocks)

| Test | Covers |
|------|--------|
| `test_full_lifecycle_with_mock_oracle` | Runner with mock oracle + mock scorer |
| `test_commitment_hash_reproducibility` | Same ground truth → same hash |
| `test_evidence_bundle_completeness` | All required files generated |
| `test_certificate_schema_validation` | Real certificate structure validates |

### E2E Test (optional, requires API keys)

| Test | Covers |
|------|--------|
| `test_live_run_small` | 3 PRs, real GitHub + real Anthropic (skipped without keys) |

---

## 6. Security Considerations

| Concern | Mitigation |
|---------|------------|
| API keys in code | Environment variables only (`GITHUB_TOKEN`, `ANTHROPIC_API_KEY`) |
| API keys in evidence bundle | Never included in bundle files |
| GitHub token scope | Read-only, public repos only |
| Large diffs in memory | Cycle-027's 100KB truncation already handles this |
| Certificate tampering | Commitment hash provides cryptographic verification |

---

## 7. Dependencies

### Python Packages (already installed)

| Package | Used By | Purpose |
|---------|---------|---------|
| `pydantic>=2.12` | Both cycles | Data models |
| `httpx>=0.28` | Cycle-027 | GitHub API, HTTP adapter |
| `anthropic>=0.74` | Cycle-027 | LLM scoring |
| `jsonschema` | Runner | Certificate validation |

### New Dependency

| Package | Purpose |
|---------|---------|
| `jsonschema` | Validate certificate against JSON Schema. If not installed, add to requirements. |

---

## 8. Sprint Breakdown (Preview)

This is a 2-sprint cycle:

**Sprint 1**: Integration Bridges + Template
- Ground truth adapter
- Oracle bridge
- Scoring bridge
- Observer template (real)
- Unit tests for all bridges

**Sprint 2**: Runner + Evidence + Validation
- Runner script (end-to-end)
- Evidence bundle generation
- Certificate schema validation
- Integration tests
- E2E test (optional)
