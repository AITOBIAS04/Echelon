{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://echelon.ai/schemas/rlmf-export/v1.0.0",
  "title": "Echelon RLMF Export Schema",
  "description": "Canonical export format for Reinforcement Learning from Market Feedback data products. This schema standardizes market supervision signals for integration with robotics training pipelines.",
  "version": "1.0.0",
  "type": "object",
  "required": [
    "episode_id",
    "theatre_id",
    "seed_hash",
    "timestep",
    "state_features",
    "market",
    "action_taken",
    "settlement",
    "calibration"
  ],
  "properties": {
    "episode_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique identifier for this training episode. Used for dataset indexing and cross-reference."
    },
    "theatre_id": {
      "type": "string",
      "pattern": "^[a-z_]+_v\\d+$",
      "description": "Identifier of the theatre template that generated this episode. References the standardized scenario definition."
    },
    "seed_hash": {
      "type": "string",
      "pattern": "^0x[a-f0-9]{64}$",
      "description": "SHA-256 hash of the random seed used to initialize this episode. Enables deterministic reproduction."
    },
    "config_hash": {
      "type": "string",
      "pattern": "^0x[a-f0-9]{64}$",
      "description": "SHA-256 hash of the theatre configuration used for this episode."
    },
    "timestep": {
      "type": "integer",
      "minimum": 0,
      "description": "Current simulation timestep within the episode. Corresponds to decision point for agent action."
    },
    "state_features": {
      "type": "object",
      "description": "Machine-readable state representation extracted from simulation engine.",
      "properties": {
        "pose": {
          "type": "object",
          "description": "6-DOF pose of the primary agent or system under evaluation.",
          "properties": {
            "position": {
              "type": "array",
              "items": { "type": "number" },
              "minItems": 3,
              "maxItems": 3,
              "description": "X, Y, Z coordinates in meters."
            },
            "orientation": {
              "type": "array",
              "items": { "type": "number" },
              "minItems": 4,
              "maxItems": 4,
              "description": "Quaternion representation (w, x, y, z)."
            },
            "velocity": {
              "type": "array",
              "items": { "type": "number" },
              "minItems": 3,
              "maxItems": 3,
              "description": "Linear velocity in m/s."
            }
          },
          "required": ["position", "orientation"]
        },
        "objects": {
          "type": "array",
          "description": "List of relevant objects in the environment with their states.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "type": { "type": "string" },
              "pose": { "type": "object", "description": "Object pose (same structure as agent pose)." },
              "state": { "type": "string", "enum": ["grasped", "free", "obstructing", "damaged"] }
            },
            "required": ["id", "type", "pose", "state"]
          }
        },
        "constraints": {
          "type": "array",
          "description": "Active constraints on the system (safety limits, task requirements).",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "type": { "type": "string", "enum": ["force_limit", "position_bounds", "velocity_bounds", "collision_avoidance"] },
              "threshold": { "type": "number" },
              "current_value": { "type": "number" },
              "violation": { "type": "boolean" }
            },
            "required": ["id", "type", "threshold", "current_value", "violation"]
          }
        }
      },
      "required": ["pose", "objects", "constraints"]
    },
    "fork": {
      "type": "object",
      "description": "Market fork information at this decision point. Null if no fork available.",
      "properties": {
        "fork_id": {
          "type": "string",
          "pattern": "^f_\\d{2}$",
          "description": "Identifier for this specific fork branch."
        },
        "parent_fork_id": {
          "type": "string",
          "pattern": "^f_\\d{2}$",
          "description": "Identifier of the parent fork this branched from."
        },
        "options": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 2,
          "maxItems": 5,
          "description": "Available action options at this decision point."
        },
        "deadline_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Time remaining before fork deadline in milliseconds."
        },
        "trigger_condition": {
          "type": "string",
          "description": "Description of what triggered this fork opportunity."
        }
      },
      "required": ["fork_id", "options", "deadline_ms"]
    },
    "market": {
      "type": "object",
      "description": "Market supervision signals at this timestep. Prices represent collective agent belief.",
      "properties": {
        "prices": {
          "type": "array",
          "items": { "type": "number", "minimum": 0, "maximum": 1 },
          "minItems": 2,
          "maxItems": 5,
          "description": "Normalized price for each option in the fork. Corresponds 1:1 with fork.options."
        },
        "liquidity": {
          "type": "integer",
          "minimum": 0,
          "description": "Total liquidity available across all option markets in $ECHELON."
        },
        "volume_24h": {
          "type": "integer",
          "minimum": 0,
          "description": "Trading volume in the last 24 hours in $ECHELON."
        },
        "logic_gap": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Divergence between market price and OSINT reality signal. Higher = less consensus."
        },
        "entropy": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Market uncertainty measured as normalized entropy of price distribution."
        },
        "agent_distribution": {
          "type": "object",
          "description": "Distribution of agent archetypes active in this market.",
          "properties": {
            "SHARK": { "type": "integer", "minimum": 0 },
            "SPY": { "type": "integer", "minimum": 0 },
            "DIPLOMAT": { "type": "integer", "minimum": 0 },
            "SABOTEUR": { "type": "integer", "minimum": 0 },
            "WHALE": { "type": "integer", "minimum": 0 },
            "DEGEN": { "type": "integer", "minimum": 0 }
          }
        },
        "consensus_trend": {
          "type": "string",
          "enum": ["converging", "stable", "diverging"],
          "description": "Trend of market consensus over recent timesteps."
        }
      },
      "required": ["prices", "liquidity", "logic_gap", "entropy"]
    },
    "action_taken": {
      "type": "string",
      "description": "The action option selected by the agent at this timestep. Must match one of fork.options if fork present."
    },
    "settlement": {
      "type": "object",
      "description": "Outcome information for this action. Populated after resolution.",
      "properties": {
        "resolved_option": {
          "type": "string",
          "description": "The option that was correct based on simulation outcome."
        },
        "success": {
          "type": "boolean",
          "description": "Whether the chosen action achieved the desired outcome."
        },
        "reward_vector": {
          "type": "object",
          "description": "Multi-dimensional reward components for this action.",
          "properties": {
            "time": { "type": "number", "description": "Reward component from completion time efficiency." },
            "value": { "type": "number", "description": "Reward component from task value achieved." },
            "collateral": { "type": "number", "description": "Reward component from resource/equipment preservation." },
            "safety": { "type": "number", "description": "Reward component from safety constraint adherence." },
            "trace": { "type": "number", "description": "Reward component from decision traceability/quality." }
          },
          "required": ["time", "value", "collateral", "safety", "trace"]
        },
        "reward_total": {
          "type": "number",
          "description": "Weighted sum of reward_vector using theatre-specified weights."
        },
        "resolution_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when this action was resolved."
        },
        "resolution_mode": {
          "type": "string",
          "enum": ["deterministic", "evidence", "manual"],
          "description": "Oracle mode used for settlement (Mode 0, 1, or 2)."
        }
      },
      "required": ["resolved_option", "success", "reward_vector"]
    },
    "calibration": {
      "type": "object",
      "description": "Market calibration metrics for this episode. Used for quality assessment.",
      "properties": {
        "brier": {
          "type": "number",
          "minimum": 0,
          "maximum": 0.5,
          "description": "Brier score measuring accuracy of probability estimates. Lower is better."
        },
        "ece": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Expected Calibration Error measuring reliability of confidence estimates."
        },
        "sharpe": {
          "type": "number",
          "description": "Risk-adjusted return of market predictions (annualized)."
        },
        "agent_accuracy": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Aggregate accuracy of agent predictions across this episode."
        },
        "sample_size": {
          "type": "integer",
          "minimum": 1,
          "description": "Number of agent decisions contributing to these metrics."
        }
      },
      "required": ["brier", "ece"]
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata for dataset management.",
      "properties": {
        "export_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp when this record was exported."
        },
        "export_version": {
          "type": "string",
          "description": "Version of the export pipeline that generated this record."
        },
        "data_quality": {
          "type": "string",
          "enum": ["excellent", "good", "marginal", "poor"],
          "description": "Quality assessment of this data point."
        },
        "difficulty_tier": {
          "type": "string",
          "enum": ["easy", "standard", "hard"],
          "description": "Difficulty tier of the theatre at this timestep."
        }
      }
    }
  }
}
